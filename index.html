<!--
    Group Name: Team Circuit
    Group members: Rajae Robinson, Ajaunie Brown, Joshua Barrett, Celine
    Module: (CIT2011: Web Programming)
    Tutor: Ms. Denise Allen
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Sail! Ship Sail! 'Ow much man deh pon board? | Game of Chance</title>
    <link rel="icon" type="image/x-icon" href="/imgs/ship.png">
    <link rel="stylesheet" href="./css/global.css">
    <script>
        // Globals
        // registration
        let playersData = []


        // play game
        const startingKernels = 100
        let playerBounty = startingKernels
        let computerBounty = startingKernels
        let maxNumOfChances = 3

        function register() {
            /*
             append the validated content to a global JavaScript array called PlayersData.
            */
            payload = {
               username: document.getElementById("username").value,
               dob: document.getElementById("dob").value,
               email: document.getElementById("email").value,
               age: document.getElementById("age").value,
               gender: document.getElementById("gender").value
           }

           playersData.push(payload)

           document.getElementById("play-btn").disabled = false
           document.getElementById("quit-btn").disabled = false
           document.getElementById("register-btn").disabled = true

           alert("Successfully registered! Click 'Play' to start")
        }

        function validateUsername(el) {
            if(el.value.length < 3) alert("Username must be greater than three characters in length")
        }

        function validateEmail(el) {
            if(!(el.value.includes("@gmail.com"))) alert("Email must be a gmail account")
        }

        function calculateAge(el) {
            let today = new Date()

            // Convert user date string value for input to separate integers
            let userDobYear = parseInt(el.value.substring(0,4))
            let userDobMonth = parseInt(el.value.substring(5,7))
            let userDobDay = parseInt(el.value.substring(8))

            let userAge = today.getFullYear() - userDobYear
            // validate user age
            if(userAge < 5) {
                alert("Age cannot be less than 5!")
            } else {
                document.getElementById("age").value = userAge
            }
        }

        function checkGuess() {
            let playerGuess
            let message = ''

            let gameData = {
                totalGames: 0,
                wins: 0,
                losses: 0,
                bounty: playerBounty
            }

            let playerGuessInputElement = document.getElementById('player-guess-input')
            playerGuess = parseInt(playerGuessInputElement.value)

            if(playerGuess > computerBounty) {
                message = "Your guess cannot be higher than your bounty!"
            } else if(playerGuess > computerHand) {
                maxNumOfChances -=1
                message = "Too high! Guess lower. You have " + maxNumOfChances + " guess(es) remaining."
            } else if(playerGuess < computerHand) {
                maxNumOfChances -= 1
                message = "Too low! Guess higher. You have " + maxNumOfChances + " guess(es) remaining."
            } else if(playerGuess === computerHand) {
                message = "You guessed correctly! " + computerHand + " kernel(s) will now be added to your bounty."
                message += "The computer took out another random set of kernels. You have three more tries. Guess again"
                maxNumOfChances = 3
                playerBounty += computerHand
                computerBounty -= computerHand
                gameData.totalGames++
                gameData.wins++
                gameData.playerBounty = playerBounty
                playerGuessInputElement.value = ''
                playGame()
            }
            
            if(maxNumOfChances === 0) {
                if (playerBounty <= 0) {
                    message = "Game over!"
                } else {
                    message = "Aw! You couldn't figure it out. The correct number was " + computerHand + ". " + computerHand + " kernel(s) will now be taken from your bounty. Select 'Play again' to continue guessing or 'Quit' to stop playing"
                    maxNumOfChances = 3
                    playerBounty -= computerHand
                    computerBounty += computerHand
                    gameData.totalGames++
                    gameData.losses++
                    gameData.playerBounty = playerBounty
                    playersData.push(gameData)
                    playerGuessInputElement.disabled = true
                    document.getElementById("guess-btn").disabled = true
                    document.getElementById("play-again-btn").disabled = false
                    playerGuessInputElement.value = ''
                    playGame()
                }
            }
            
            if(computerBounty <= 0) {
                message = "You win! Computer has no kernels left."
                maxNumOfChances = 3
                gameData.wins++
                playersData.push(gameData)
                playerGuessInputElement.disabled = true
                document.getElementById("guess-btn").disabled = true
                document.getElementById("play-again-btn").disabled = false
            }

            document.getElementById("game-message").innerHTML = message
        }

        function playGame(isPlayAgain) {
            // set computer hand by randomly generating the number of kernels in computers hand
            computerHand = Math.floor((Math.random() * computerBounty) + 1)
            console.log("hand:", computerHand)

            // If the user clicks the try again button, re-enable guess input field
            if(isPlayAgain) {
                document.getElementById('player-guess-input').disabled = false
                document.getElementById("guess-btn").disabled = false
            }

            // show game UI
            document.querySelector(".game").classList.remove("hide")

            // Setting constraints for bounties, so no negative number is shown or no number 
            // greater than the startingKernels is shown
            if(playerBounty < 0 ) playerBounty = 0
            if(computerBounty < 0 ) computerBounty = 0
            if(playerBounty > startingKernels * 2) playerBounty = startingKernels * 2
            if(computerBounty > startingKernels * 2) computerBounty = startingKernels * 2

            // Showing the player's bounty
            document.querySelector(".player-bounty").innerHTML = `${document.getElementById("username").value}'s bounty: ${playerBounty} kernels.`
            // Showing the computer's bounty
            document.querySelector(".computer-bounty").innerHTML = "Computer bounty: " + computerBounty + " kernels."
        }

        function findPercentageScore() {
            showPercentageTextArea = document.getElementById("show-percentage")

            showPercentageTextArea.value = ""

            percentageScoreString = `Name: ${document.getElementById("username").value}Date: ${new Date()}<br/>Total games: ${playersData[1].totalGames}, Games won: ${playersData[1].wins},
                                    Games lost: ${playersData[1].losses}, Percentage won: ${Math.floor(playersData[1].wins/playersData[1].losses * 100)}%`

            showPercentageTextArea.value = percentageScoreString
        }
    </script>
</head>
<body>
    <!-- Registration form -->
    <form id="player-registration">
        <h1>Registration</h1>
        <label for="username">Username:</label>
        <input type="text" name="username" id="username" onBlur="validateUsername(this)"><br/><br/>

        <label for="dob">Date of birth:</label>
		<input type="date" id="dob" name="dob" onblur="calculateAge(this)"></input><br/><br/>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" placeholder="john@gmail.com" size="40" 
        maxlength="25" onblur="validateEmail(this)"></input><br/><br/>

        <label for="age">Age:</label>
		<input type="number" id="age" name="age"></input><br/><br/>

        <label for="gender">Gender:</label>
        <input type="radio" id="gender" name="gender" value='males'>Male</input>
        <input type="radio" id="gender" name="gender" value='females'>Female</input><br/><br/>

        <input id="register-btn" type="button" value="Register" onclick="register()">
        <input id="play-btn" type="button" onclick="playGame(false)" value="Play" disabled>
        <input id="quit-btn" type="button" onclick="findPercentageScore()" value="Quit" disabled><br/><br/>

        <h2>Game Statistics</h2>
        <textarea id="show-percentage" rows="5" cols="30"></textarea>
    </form>
    
    <!-- Game Screen -->
    <div class="game hide">
        <h1>Ship Sail! Ship Sail! 'Ow much man deh pon board?</h1>
        <p class="player-bounty"></p>
        <p class="computer-bounty"></p>
        <label for="player-guess-input">Guess the number of kernels in the computer's hand:</label>
        <input type="number" id="player-guess-input">
        <input id="guess-btn" type="button" value="Guess" onclick="checkGuess()">
        <input id="play-again-btn" type="button" value="Play Again" onclick="playGame(true)" disabled>
        <p id="game-message"></p>
    </div>
</body>
</html>